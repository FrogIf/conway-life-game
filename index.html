<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>Conway's Game of Life</title>
        <style>
            .eye-button{
                width: 15px;
                height: 15px;
                cursor: pointer;
            }
            .eye-button span{
                width: 2px;
                height: 2px;
                position: absolute;
            }
            .eye-button span:nth-of-type(1){
                right: 20%;
                top: 20%;
                background-color: #009E60;
            }
            .eye-button span:nth-of-type(2){
                right: 50%;
                top: 20%;
                background-color: #FF5800;
            }
            .eye-button span:nth-of-type(3){
                right: 80%;
                top: 20%;
                background-color: #FFD500;
            }
            .eye-button span:nth-of-type(4){
                right: 20%;
                top: 50%;
                background-color: #C41E3A;
            }
            .eye-button span:nth-of-type(5){
                right: 50%;
                top: 50%;
                background-color: #FFFFFF;
            }
            .eye-button span:nth-of-type(6){
                right: 80%;
                top: 50%;
                background-color: #0051BA;
            }
            .eye-button span:nth-of-type(7){
                right: 20%;
                top: 80%;
                background-color: #FFD500;
            }
            .eye-button span:nth-of-type(8){
                right: 50%;
                top: 80%;
                background-color: #FF5800;
            }
            .eye-button span:nth-of-type(9){
                right: 80%;
                top: 80%;
                background-color: #009E60;
            }
            .right-control-panel{
                right: 10px;
                top: 0px;
                position: fixed;
                width: 200px;
                height: 590px;
                border-radius: 5px;
                background-color: rgba(191,191,191,0.4);
                padding: 10px 10px;
            }
            .group-panel{
                border: 1px solid gray; 
                border-radius: 5px; 
                padding: 5px; 
                margin-top: 5px;
            }
        </style>
	</head>
	<body>
        <canvas id="gridCanvas" style="cursor: pointer;"></canvas>
        <div id="menuBtn" class="eye-button" style="position:fixed;right:0px;top:0px;">
            <span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span>
        </div>
        <div id="menuPanel" class="right-control-panel">
            <div class="group-panel">
                <div><div style="width: 80px;display: inline-block;">行数(row):</div><input id="rowCount" type="number" style="width: 80px;" value="50" ></div>
                <div><div style="width: 80px;display: inline-block;">列数(col):</div><input id="colCount" type="number" style="width: 80px;" value="100"></div>
                <div style="align-items: center; display: grid; padding: 5px;">
                    <button class="need-forbidden" onclick="reDraw()">重绘</button>
                </div>
                <div style="align-items: center; padding: 5px;" class="group-panel">
                    <div>
                        <div style="width: 20px;display: inline-block;">←</div>
                        <input id="leftExtCount" type="number" style="width: 50px;" value="0" >
                        <div style="width: 20px;display: inline-block;">↑</div>
                        <input id="topExtCount" type="number" style="width: 50px;" value="0" >
                    </div>
                    <div>
                        <div style="width: 20px;display: inline-block;">→</div>
                        <input id="rightExtCount" type="number" style="width: 50px;" value="0" >
                        <div style="width: 20px;display: inline-block;">↓</div>
                        <input id="bottomExtCount" type="number" style="width: 50px;" value="0" >
                    </div>
                    <div style="align-items: right; margin-bottom: 10px;">
                        <button style="position:relative; right: -134px; top: 5px;" class="need-forbidden" onclick="extend()">扩展</button>
                    </div>
                </div>
                <div class="group-panel">
                    <div><input id="selectCheckbox" class="need-forbidden" type="checkbox" onchange="toggleSelectable()" /><span>选择区域</span></div>
                    <div style="margin-top: 5px;">
                        <button class="need-forbidden" style="width: 30px;" onclick="moveSelected(0, -1)">←</button>
                        <button class="need-forbidden" style="width: 30px;" onclick="moveSelected(0, 1)">→</button>
                        <button class="need-forbidden" style="width: 30px;" onclick="moveSelected(-1, 0)">↑</button>
                        <button class="need-forbidden" style="width: 30px;" onclick="moveSelected(1, 0)">↓</button>
                    </div>
                    <div style="margin-top: 5px;">
                        <button class="need-forbidden" style="width: 80px;" onclick="clearSelected()">清除选择</button>
                        <button class="need-forbidden" style="width: 80px;" onclick="clearOthers()">清除其他</button>
                    </div>
                </div>
                <div style="margin-top: 5px;">
                    <input id="editCheckbox" class="need-forbidden" type="checkbox" onchange="toggleEditable()" /><span>启用编辑</span>
                </div>
                <div style="align-items: center; display: grid; padding: 5px;"><button class="need-forbidden" onclick="randomPoint()">随机</button></div>
            </div>
            <div class="group-panel">
                <div><input id="edgeStyle" type="checkbox" checked="true" class="need-forbidden" /><span>周期边界</span></div>
                <div>速度: <input id="speed" class="need-forbidden" value="200" type="number" style="width: 50px;">ms/step</div>
                <div style="align-items: center; display: grid; padding: 5px; display: inline-block;">
                    <button id="nextBtn" onclick="next()" class="need-forbidden">下一步</button>
                    <button id="runBtn" onclick="run()">运行</button>
                </div>
            </div>
            <div class="group-panel">
                <div>
                    <div style="align-items: center; display: grid; padding: 5px;"><button class="need-forbidden" onclick="dump()">下载</button></div>
                </div>
                <div class="group-panel">
                    加载: <input class="need-forbidden" type="file" id="fileInput" accept=".cl">
                </div>
                <div>
                    示例: 
                    <select id="demoSelect">
                        <option value="0" selected>无</option>
                        <option value="1">稳定结构1</option>
                        <option value="2">稳定结构2</option>
                        <option value="3">振荡器1</option>
                        <option value="4">振荡器2</option>
                        <option value="5">滑翔机1</option>
                        <option value="6">滑翔机2</option>
                        <option value="7">高斯帕机枪</option>
                    </select>
                    <div style="align-items: center; display: grid; padding: 5px;"><button id="demoBtn" class="need-forbidden" onclick="drawDemo()">绘制</button></div>
                </div>
            </div>
        </div>
        <script>
            // 这里行用width指定
            function makeConwaySpace(rowCount, colCount){
                const cellSize = 10; // 每个网格单元的大小
                const canvas = document.getElementById('gridCanvas');
                const ctx = canvas.getContext('2d');
                const aliveColor = 'black';
                const emptyColor = 'white';
                const selectedColor = '#ccffcc';
                const bkColorArr = [ selectedColor ];

                var conwaySpace = {};
                var editable = false;
                var selectDoing = false;

                var selectedStartRow = -1;
                var selectedEndRow = -1;
                var selectedStartCol = -1;
                var selectedEndCol = -1;

                conwaySpace.getRange = () => {
                    return {
                        startRow: 0,
                        endRow: rowCount - 1,
                        startCol: 0,
                        endCol: colCount - 1
                    }
                };

                conwaySpace.getSelectedRange = () => {
                    return {
                        startRow: selectedStartRow,
                        endRow: selectedEndRow,
                        startCol: selectedStartCol,
                        endCol: selectedEndCol
                    };
                }
                
                conwaySpace.enableEdit = () => { editable = true; }
                conwaySpace.disableEdit = () => { editable = false; }
                conwaySpace.enableSelect = () => { selectDoing = true; }
                conwaySpace.disableSelect = () => { 
                    selectDoing = false;
                    selectedStartRow = -1;
                    selectedEndRow = -1;
                    selectedStartCol = -1;
                    selectedEndCol = -1;
                    for(let r = 0; r < conwaySpace.backgroupGrid.length; r++){
                        let rows = conwaySpace.backgroupGrid[r];
                        for(let c = 0; c < rows.length; c++){
                            if(rows[c] == 1 && conwaySpace.gridMarks[r][c] == 0){
                                conwaySpace.removePoint(r, c);
                            }
                        }
                    }
                }

                function isInSelect(r, c){
                    return r >= selectedStartRow && r <= selectedEndRow && c >= selectedStartCol && c <= selectedEndCol;
                }
                
                function isSelectRangeExist(){
                    return selectedStartRow >= 0 && selectedEndRow >= 0 && selectedStartCol >= 0 && selectedEndCol >= 0;
                }

                conwaySpace.draw = function(rc, cc){
                    rowCount = rc;
                    colCount = cc;
                    conwaySpace.gridMarks = Array.from({ length: rowCount }, () => 
                        Array(colCount).fill(0)
                    );
                    conwaySpace.backgroupGrid = Array.from({ length: rowCount }, () => 
                        Array(colCount).fill(0)
                    );
                    selectedStartRow = -1;
                    selectedEndRow = -1;
                    selectedStartCol = -1;
                    selectedEndCol = -1;
                    
                    canvas.width = colCount * cellSize;
                    canvas.height = rowCount * cellSize;
            
                    // 设置线条样式
                    ctx.strokeStyle = '#ccc'; // 灰色线条
                    ctx.lineWidth = 1;
                    ctx.imageSmoothingEnabled = false;
            
                    // 绘制垂直线
                    for (let x = 0; x <= colCount; x += 1) {
                        ctx.beginPath();
                        ctx.moveTo(x * cellSize, 0);
                        ctx.lineTo(x * cellSize, rowCount * cellSize);
                        ctx.stroke();
                    }
                    // 绘制水平线
                    for (let y = 0; y <= rowCount; y += 1) {
                        ctx.beginPath();
                        ctx.moveTo(0, y * cellSize);
                        ctx.lineTo(colCount * cellSize, y * cellSize);
                        ctx.stroke();
                    }
                }

                conwaySpace.draw(rowCount, colCount);
                
                // 涂黑格子, 坐标从(0, 0)开始
                conwaySpace.drawPoint = function(row, col){
                    conwaySpace.gridMarks[row][col] = 1;
                    brushPointWithColor(row, col, aliveColor);
                }

                // 反转一个细胞的存活状态
                conwaySpace.invertPointStatus = function(row, col){
                    if(conwaySpace.gridMarks[row][col] == 1){
                        conwaySpace.removePoint(row, col);
                    }else{
                        conwaySpace.drawPoint(row, col);
                    }
                }

                function brushPointWithColor(row, col, color){
                    // 计算目标格子的左上角坐标
                    const startX = col * cellSize + 1;
                    const startY = row * cellSize + 1;
                    // 绘制黑色矩形覆盖目标格子
                    ctx.fillStyle = color; // 设置填充颜色为黑色
                    ctx.fillRect(startX, startY, cellSize - 2, cellSize - 2); // 绘制矩形
                }

                conwaySpace.removePoint = function(row, col){
                    conwaySpace.gridMarks[row][col] = 0;
                    if(isInSelect(row, col)){
                        brushPointWithColor(row, col, selectedColor);
                    }else{
                        brushPointWithColor(row, col, emptyColor);
                    }
                }

                // 清空画布
                conwaySpace.clear = function(){
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                }

                canvas.addEventListener('click', (event) => {
                    if(!editable){
                        return;
                    }
                    const rect = canvas.getBoundingClientRect();
                    const mouseX = event.clientX - rect.left; // 获取鼠标点击的 X 坐标
                    const mouseY = event.clientY - rect.top; // 获取鼠标点击的 Y 坐标

                    // 计算点击的行列号
                    const clickedRow = Math.floor(mouseY / cellSize);
                    const clickedCol = Math.floor(mouseX / cellSize);

                    // 检查是否在有效范围内
                    if (clickedRow >= 0 && clickedRow < rowCount && clickedCol >= 0 && clickedCol < colCount) {
                        // 切换颜色逻辑
                        let currentMark = conwaySpace.gridMarks[clickedRow][clickedCol];
                        conwaySpace.gridMarks[clickedRow][clickedCol] = 1 - currentMark;

                        if(currentMark == 0){ // 原来是白色, 需要涂黑
                            conwaySpace.drawPoint(clickedRow, clickedCol);
                        }else{
                            conwaySpace.removePoint(clickedRow, clickedCol);
                            if(isInSelect(clickedRow, clickedCol)){
                                brushPointWithColor(clickedRow, clickedCol, selectedColor);
                            }
                        }
                    }
                });

                var startSelectRowNum = -1;
                var startSelectColNum = -1;
                canvas.addEventListener('mousedown', (event) => {
                    startSelectRowNum = -1;
                    endSelectColNum = -1;
                    if(!selectDoing){
                        return;
                    }
                    const rect = canvas.getBoundingClientRect();
                    const mouseX = event.clientX - rect.left; // 获取鼠标点击的 X 坐标
                    const mouseY = event.clientY - rect.top; // 获取鼠标点击的 Y 坐标

                    // 计算点击的行列号
                    const clickedRow = Math.floor(mouseY / cellSize);
                    const clickedCol = Math.floor(mouseX / cellSize);

                    // 检查是否在有效范围内
                    if (clickedRow >= 0 && clickedRow < rowCount && clickedCol >= 0 && clickedCol < colCount) {
                        startSelectRowNum = clickedRow;
                        startSelectColNum = clickedCol;
                    }
                });

                canvas.addEventListener('mouseup', (event) => {
                    if(!selectDoing || startSelectRowNum < 0 || startSelectColNum < 0){
                        return;
                    }
                    const rect = canvas.getBoundingClientRect();
                    const mouseX = event.clientX - rect.left; // 获取鼠标点击的 X 坐标
                    const mouseY = event.clientY - rect.top; // 获取鼠标点击的 Y 坐标

                    // 计算点击的行列号
                    const clickedRow = Math.floor(mouseY / cellSize);
                    const clickedCol = Math.floor(mouseX / cellSize);

                    if(clickedRow == startSelectRowNum && clickedCol == startSelectColNum){ return; }

                    // 检查是否在有效范围内
                    if (clickedRow >= 0 && clickedRow < rowCount && clickedCol >= 0 && clickedCol < colCount) {
                        selectedStartRow = Math.min(clickedRow, startSelectRowNum);
                        selectedEndRow = Math.max(clickedRow, startSelectRowNum);
                        selectedStartCol = Math.min(clickedCol, startSelectColNum);
                        selectedEndCol = Math.max(clickedCol, startSelectColNum);

                        // 选中区域染色
                        for(let r = 0; r < conwaySpace.backgroupGrid.length; r++){
                            let rows = conwaySpace.backgroupGrid[r];
                            for(let c = 0; c < rows.length; c++){
                                let isAlivePoint = conwaySpace.gridMarks[r][c] == 1;
                                if(isInSelect(r, c)){
                                    conwaySpace.backgroupGrid[r][c] = 1;
                                    if(!isAlivePoint) { brushPointWithColor(r, c, selectedColor); }
                                }else{
                                    conwaySpace.backgroupGrid[r][c] = 0;
                                    if(!isAlivePoint) { conwaySpace.removePoint(r, c); }
                                }
                            }
                        }
                    }else{
                        startSelectRowNum = -1;
                        startSelectColNum = -1;
                    }
                });

                conwaySpace.next = (period) => {
                    let newMarkMap = Array.from({ length: rowCount }, () => 
                        Array(colCount).fill(0)
                    );

                    let mr = conwaySpace.gridMarks.length;
                    for(let r = 0; r < mr; r++){
                        let mc = conwaySpace.gridMarks[r].length;
                        for(let c = 0; c < mc; c++){
                            let m = conwaySpace.gridMarks[r][c];

                            let liveNeighbor = 0;
                            if(period){ // 周期边界
                                let r0 = r - 1; // 上一行
                                if(r0 < 0){ r0 = mr - 1; }

                                let r1 = r + 1; // 下一行
                                if(r1 >= mr){ r1 = 0; }

                                let c0 = c - 1; // 前一列
                                if(c0 < 0){ c0 = mc - 1; }
                                
                                let c1 = c + 1; // 后一列
                                if(c1 >= mc){ c1 = 0; }

                                if(conwaySpace.gridMarks[r0][c0] == 1){ liveNeighbor++; }
                                if(conwaySpace.gridMarks[r0][c] == 1){ liveNeighbor++; }
                                if(conwaySpace.gridMarks[r0][c1] == 1){ liveNeighbor++; }
                                if(conwaySpace.gridMarks[r][c0] == 1){ liveNeighbor++; }
                                if(conwaySpace.gridMarks[r][c1] == 1){ liveNeighbor++; }
                                if(conwaySpace.gridMarks[r1][c0] == 1){ liveNeighbor++; }
                                if(conwaySpace.gridMarks[r1][c] == 1){ liveNeighbor++; }
                                if(conwaySpace.gridMarks[r1][c1] == 1){ liveNeighbor++; }
                            }else{
                                liveNeighbor = 8;

                                let c0 = c - 1; // 前一列
                                let c1 = c + 1; // 后一列
                                if(c0 < 0 || conwaySpace.gridMarks[r][c0] == 0){ liveNeighbor--; }
                                if(c1 >= mc || conwaySpace.gridMarks[r][c1] == 0){ liveNeighbor--; }

                                let r0 = r - 1; // 上一行
                                if(r0 < 0){ liveNeighbor -= 3; }
                                else{
                                    if(c0 < 0 || conwaySpace.gridMarks[r0][c0] == 0){ liveNeighbor--; }
                                    if(c1 >= mc || conwaySpace.gridMarks[r0][c1] == 0){ liveNeighbor--; }
                                    if(conwaySpace.gridMarks[r0][c] == 0){ liveNeighbor--; }
                                }

                                let r1 = r + 1; // 下一行
                                if(r1 >= mr){ liveNeighbor -= 3; }
                                else{
                                    if(c0 < 0 || conwaySpace.gridMarks[r1][c0] == 0){ liveNeighbor--; }
                                    if(c1 >= mc || conwaySpace.gridMarks[r1][c1] == 0){ liveNeighbor--; }
                                    if(conwaySpace.gridMarks[r1][c] == 0){ liveNeighbor--; }
                                }
                            }

                            if(m == 1){
                                if(liveNeighbor == 2 || liveNeighbor == 3){ // 存活规则
                                    newMarkMap[r][c] = 1;
                                }else{ // 死亡
                                    newMarkMap[r][c] = 0;
                                }
                            }else{
                                if(liveNeighbor == 3){  // 出生规则
                                    newMarkMap[r][c] = 1;
                                }
                            }
                        }
                    }

                    for(let r = 0; r < rowCount; r++){
                        for(let c = 0; c < colCount; c++){
                            let m = newMarkMap[r][c];
                            if(m != conwaySpace.gridMarks[r][c]){
                                if(m == 0){
                                    conwaySpace.removePoint(r, c);
                                }else{
                                    conwaySpace.drawPoint(r, c);
                                }
                            }
                        }
                    }
                }

                conwaySpace.dump = function(){
                    let mr = conwaySpace.gridMarks.length;
                    let dumpContent = "";
                    for(let r = 0; r < mr; r++){
                        if(r > 0){ dumpContent += '\n'; }
                        let mc = conwaySpace.gridMarks[r].length;
                        dumpContent += conwaySpace.gridMarks[r].join(',');
                    }
                    return dumpContent;
                }

                function refreshPoint(){
                    for(let r = 0; r < rowCount; r++){
                        for(let c = 0; c < colCount; c++){
                            if(conwaySpace.gridMarks[r][c] == 1){
                                conwaySpace.drawPoint(r, c);
                            }else{
                                let bv = conwaySpace.backgroupGrid[r][c];
                                if(bv > 0){
                                    brushPointWithColor(r, c, bkColorArr[bv - 1]);
                                }else{
                                    conwaySpace.removePoint(r, c);
                                }
                            }
                        }
                    }
                }

                conwaySpace.read = function(origin){
                    let rows = origin.split('\n');
                    let newRowCount = rows.length;
                    let newColCount = 0;
                    let marks = new Array();
                    for(let row of rows){
                        let arr = [];
                        let cols = row.split(',');
                        if(newColCount < cols.length){
                            newColCount = cols.length;
                        }
                        for(let col of cols){
                            arr.push(col == '1' ? 1 : 0);
                        }
                        marks.push(arr);
                    }
                    conwaySpace.clear();

                    // 如果原有画布比导入的画布大, 保留原有画布尺寸
                    let expand = false;
                    if(newColCount < colCount){ newColCount = colCount; expand = true; }
                    if(newRowCount < rowCount){ newRowCount = rowCount; expand = true; }
                    conwaySpace.draw(newRowCount, newColCount);

                    if(expand){
                        for(let r = 0; r < marks.length; r++){
                            for(let c = 0; c < marks[r].length; c++){
                                conwaySpace.gridMarks[r][c] = marks[r][c];
                            }
                        }
                    }else{
                        conwaySpace.gridMarks = marks;
                    }

                    refreshPoint();
                }

                conwaySpace.extend = (left, top, right, bottom) => {
                    let newColCount = colCount + left + right;
                    let newRowCount = rowCount + top + bottom;
                    if(newColCount <= 0 || newRowCount <= 0){ return; }
                    let newGrid = Array.from({ length: newRowCount }, () => 
                        Array(newColCount).fill(0)
                    );
                    for(let r = 0; r < conwaySpace.gridMarks.length; r++){
                        for(let c = 0; c < conwaySpace.gridMarks[r].length; c++){
                            let tr = r + top;
                            let tc = c + left;
                            if(tr >= 0 && tr < newRowCount && tc >= 0 && tc < newColCount){
                                newGrid[tr][tc] = conwaySpace.gridMarks[r][c];
                            }
                        }
                    }
                    conwaySpace.clear();
                    conwaySpace.draw(newRowCount, newColCount);
                    conwaySpace.gridMarks = newGrid;
                    refreshPoint();
                };

                conwaySpace.moveSelected = (rowOffset, colOffset) => {
                    if((rowOffset == 0 && colOffset == 0) || !isSelectRangeExist()){ return; }
                    
                    let newBackgroupGrid = Array.from({ length: rowCount }, () => 
                        Array(colCount).fill(0)
                    );
                    let newGridMarks = Array.from({ length: rowCount }, () => 
                        Array(colCount).fill(0)
                    );
                    for(let r = selectedStartRow; r <= selectedEndRow; r++){
                        for(let c = selectedStartCol; c <= selectedEndCol; c++){
                            let nr = r + rowOffset;
                            let nc = c + colOffset;
                            if(nr >= 0 && nr < rowCount && nc >= 0 && nc < colCount){
                                newBackgroupGrid[nr][nc] = 1;
                                newGridMarks[nr][nc] = conwaySpace.gridMarks[r][c];
                            }
                        }
                    }

                    for(let r = 0; r < rowCount; r++){
                        for(let c = 0; c < colCount; c++){
                            if(newBackgroupGrid[r][c] == 1){ // 选区中
                                conwaySpace.backgroupGrid[r][c] = 1;
                                conwaySpace.gridMarks[r][c] = newGridMarks[r][c];
                            }else if(conwaySpace.backgroupGrid[r][c] == 1){
                                conwaySpace.backgroupGrid[r][c] = 0;
                                conwaySpace.gridMarks[r][c] = 0;
                            }
                        }
                    }
                    selectedStartRow += rowOffset;
                    selectedEndRow += rowOffset;
                    selectedStartCol += colOffset;
                    selectedEndCol += colOffset;
                    if((selectedStartCol < 0 && selectedEndCol < 0) 
                        || (selectedStartRow < 0 && selectedEndRow < 0)
                        || (selectedStartCol >= colCount && selectedEndCol >= colCount)
                        || (selectedStartRow >= rowCount && selectedEndRow >= rowCount)
                    ){ // 整个选区超出范
                        selectedStartRow = -1;
                        selectedEndRow = -1;
                        selectedStartCol = -1;
                        selectedEndCol = -1;
                    }else{
                        if(selectedStartRow < 0){ selectedStartRow = 0; }
                        else if(selectedStartRow >= rowCount){ selectedStartRow = rowCount - 1; }
                        
                        if(selectedEndRow < 0){ selectedEndRow = 0; }
                        else if(selectedEndRow >= rowCount){ selectedEndRow = rowCount - 1; }

                        if(selectedStartCol < 0){ selectedStartCol = 0; }
                        else if(selectedStartCol >= colCount){ selectedStartCol = colCount - 1; }
                        
                        if(selectedEndCol < 0){ selectedEndCol = 0; }
                        else if(selectedEndCol >= colCount){ selectedEndCol = colCount - 1; }
                    }

                    refreshPoint();
                };

                return conwaySpace;
            }

            document.getElementById("menuBtn").onclick = (e) => {
                let panel = document.getElementById("menuPanel");
                if(panel.style.display == "none"){
                    panel.style.display = "block";
                }else{
                    panel.style.display = "none";
                }
            }

            const conwaySpace = makeConwaySpace(Number(document.getElementById('rowCount').value), Number(document.getElementById('colCount').value));
            
            function reDraw(){
                conwaySpace.clear();
                conwaySpace.draw(Number(document.getElementById('rowCount').value), Number(document.getElementById('colCount').value));
            }

            function extend(){
                let l = Number(document.getElementById('leftExtCount').value);
                let r = Number(document.getElementById('rightExtCount').value);
                let t = Number(document.getElementById('topExtCount').value);
                let b = Number(document.getElementById('bottomExtCount').value);
                conwaySpace.extend(l,t,r,b);
                document.getElementById('leftExtCount').value = 0;
                document.getElementById('rightExtCount').value = 0;
                document.getElementById('topExtCount').value = 0;
                document.getElementById('bottomExtCount').value = 0;
            }

            function toggleEditable(){
                if(document.getElementById('editCheckbox').checked && !document.getElementById('editCheckbox').disabled){
                    conwaySpace.enableEdit();
                }else{
                    conwaySpace.disableEdit();
                }
            }

            function toggleSelectable(){
                if(document.getElementById('selectCheckbox').checked && !document.getElementById('selectCheckbox').disabled){
                    conwaySpace.enableSelect();
                }else{
                    conwaySpace.disableSelect();
                }
            }

            function next(){
                conwaySpace.next(document.getElementById('edgeStyle').checked);
            }

            var running = false;
            var intervalId;
            function run(){
                if(running){
                    if(intervalId){
                        clearInterval(intervalId);
                    }

                    running = false;
                    let controls = document.getElementsByClassName('need-forbidden');
                    for(let c of controls){
                        c.disabled = false;
                    }

                    toggleEditable();
                    toggleSelectable();
                    document.getElementById('runBtn').innerText = '运行';
                }else{
                    let p = document.getElementById('speed').value;
                    if(p < 100){ 
                        alert("速度太快"); 
                        return;
                    }

                    running = true;
                    let controls = document.getElementsByClassName('need-forbidden');
                    for(let c of controls){
                        c.disabled = true;
                    }
                    toggleEditable();
                    toggleSelectable();
                    document.getElementById('runBtn').innerText = '停止';

                    var period = document.getElementById('edgeStyle').checked;

                    // setInterval使用的是任务队列, 如果内部耗时过长, 可能有队列积压的风险
                    intervalId = setInterval(() => {
                        conwaySpace.next(period);
                    }, p);
                }
            }

            function dump(){
                // 文件内容
                let fileContent = conwaySpace.dump();

                // 创建 Blob 对象
                let blob = new Blob([fileContent], { type: "text/plain" });

                // 生成文件 URL
                let url = URL.createObjectURL(blob);

                // 创建 <a> 标签并触发下载
                let a = document.createElement("a");
                a.href = url;
                a.download = "dump.cl"; // 设置文件名
                a.click();

                // 释放 URL 对象
                URL.revokeObjectURL(url);
            }

            document.getElementById('fileInput').addEventListener('change', (event) => {
                const file = event.target.files[0]; // 获取用户选择的文件

                if (file) {
                    const reader = new FileReader();

                    // 当文件读取完成时触发
                    reader.onload = function (e) {
                        const content = e.target.result; // 文件内容
                        conwaySpace.read(content);
                    };

                    // 如果需要处理错误
                    reader.onerror = function () {
                        alert("文件读取出错");
                    };

                    // 开始读取文件
                    reader.readAsText(file); // 读取为文本
                }
            });


            let demoArr = [
                // 稳定1-方块
                "0,0,0,0,0,0,0,0\n0,0,0,0,0,0,0,0\n0,0,0,0,0,0,0,0\n0,0,0,1,1,0,0,0\n0,0,0,1,1,0,0,0\n0,0,0,0,0,0,0,0\n0,0,0,0,0,0,0,0\n0,0,0,0,0,0,0,0",
                // 稳定2-池塘
                "0,0,0,0,0,0,0,0\n0,0,0,0,0,0,0,0\n0,0,0,1,1,0,0,0\n0,0,1,0,0,1,0,0\n0,0,1,0,0,1,0,0\n0,0,0,1,1,0,0,0\n0,0,0,0,0,0,0,0\n0,0,0,0,0,0,0,0",
                // 震荡1
                "0,0,0,0,0,0,0,0\n0,0,0,0,0,0,0,0\n0,0,0,1,0,0,0,0\n0,0,0,1,0,0,0,0\n0,0,0,1,0,0,0,0\n0,0,0,0,0,0,0,0\n0,0,0,0,0,0,0,0\n0,0,0,0,0,0,0,0",
                // 震荡2
                "0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0\n0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0\n0,0,0,0,0,1,1,1,0,0,0,1,1,1,0,0,0,0,0,0\n0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0\n0,0,0,1,0,0,0,0,1,0,1,0,0,0,0,1,0,0,0,0\n0,0,0,1,0,0,0,0,1,0,1,0,0,0,0,1,0,0,0,0\n0,0,0,1,0,0,0,0,1,0,1,0,0,0,0,1,0,0,0,0\n0,0,0,0,0,1,1,1,0,0,0,1,1,1,0,0,0,0,0,0\n0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0\n0,0,0,0,0,1,1,1,0,0,0,1,1,1,0,0,0,0,0,0\n0,0,0,1,0,0,0,0,1,0,1,0,0,0,0,1,0,0,0,0\n0,0,0,1,0,0,0,0,1,0,1,0,0,0,0,1,0,0,0,0\n0,0,0,1,0,0,0,0,1,0,1,0,0,0,0,1,0,0,0,0\n0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0\n0,0,0,0,0,1,1,1,0,0,0,1,1,1,0,0,0,0,0,0\n0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0\n0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0\n0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0\n0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0\n0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0",
                // 滑翔机1
                "0,0,1,0,0,0,0,0,0,0\n1,0,1,0,0,0,0,0,0,0\n0,1,1,0,0,0,0,0,0,0\n0,0,0,0,0,0,0,0,0,0\n0,0,0,0,0,0,0,0,0,0\n0,0,0,0,0,0,0,0,0,0\n0,0,0,0,0,0,0,0,0,0\n0,0,0,0,0,0,0,0,0,0\n0,0,0,0,0,0,0,0,0,0\n0,0,0,0,0,0,0,0,0,0",
                // 滑翔机2
                "0,0,0,0,0,0,0,0,0,0\n0,0,0,0,0,0,0,0,0,0\n0,0,1,1,1,1,0,0,0,0\n0,1,0,0,0,1,0,0,0,0\n0,0,0,0,0,1,0,0,0,0\n0,1,0,0,1,0,0,0,0,0\n0,0,0,0,0,0,0,0,0,0\n0,0,0,0,0,0,0,0,0,0\n0,0,0,0,0,0,0,0,0,0\n0,0,0,0,0,0,0,0,0,0",
                // 高斯帕机枪
                "0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0\n0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0\n0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0\n0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0\n0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1,0,0,0,0,0,1,1,0,0,0,1,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0\n0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,1,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0\n0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,1,1,0,1,1,0,0,0,0,0,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0\n0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,1,1,0,1,0,0,0,0,0,0,0,0,1,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0\n0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0\n0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0\n0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0\n0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0\n0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0\n0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0\n0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0\n0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0\n0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0\n0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0\n0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0\n0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0\n0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0\n0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0\n0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0\n0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0\n0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0\n0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0\n0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0\n0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0\n0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0\n0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0"
            ];
            function drawDemo(){
                let index = Number(document.getElementById("demoSelect").value) - 1;
                if(index >= 0){
                    conwaySpace.read(demoArr[index]);
                }
            }

            function moveSelected(rowOffset, colOffsset){
                conwaySpace.moveSelected(rowOffset, colOffsset);
            }

            function randomPoint(){
                let selectedRange = conwaySpace.getSelectedRange();
                let randomRange;
                if(selectedRange.startRow >= 0 && selectedRange.endCol >= 0 && selectedRange.startCol >= 0 && selectedRange.endRow >= 0){
                    randomRange = selectedRange;
                }else{
                    randomRange = conwaySpace.getRange();
                }

                for(let r = randomRange.startRow; r <= randomRange.endRow; r++){
                    for(let c = randomRange.startCol; c <= randomRange.endCol; c++){
                        if(Math.random() >= 0.5){
                            conwaySpace.invertPointStatus(r, c);
                        }
                    }
                }
            }

            function clearSelected(){
                let selectedRange = conwaySpace.getSelectedRange();
                if(selectedRange.startRow >= 0 && selectedRange.endCol >= 0 && selectedRange.startCol >= 0 && selectedRange.endRow >= 0){
                    for(let r = selectedRange.startRow; r <= selectedRange.endRow; r++){
                        for(let c = selectedRange.startCol; c <= selectedRange.endCol; c++){
                            conwaySpace.removePoint(r, c);
                        }
                    }
                }
            }

            function clearOthers(){
                let selectedRange = conwaySpace.getSelectedRange();
                if(selectedRange.startRow >= 0 && selectedRange.endCol >= 0 && selectedRange.startCol >= 0 && selectedRange.endRow >= 0){
                    let totalRange = conwaySpace.getRange();
                    for(let r = totalRange.startRow; r <= totalRange.endRow; r++){
                        for(let c = totalRange.startCol; c <= totalRange.endCol; c++){
                            if(r < selectedRange.startRow || r > selectedRange.endRow || c < selectedRange.startCol || c > selectedRange.endCol){
                                conwaySpace.removePoint(r, c);
                            }
                        }
                    } 
                }
            }
        </script>
	</body>
</html>